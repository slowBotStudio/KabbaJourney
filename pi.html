<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑ –ø–æ–µ–∑–¥–∫–∏ Cabbakid üö¥‚Äç‚ôÇÔ∏èüí©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            animation: fadeIn 1s ease-in;
        }
        /* Animated poop emoji wallpaper at the very back */
        .poop-background {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            opacity: 0.08;
        }
        .poop-background .poop {
            position: absolute;
            font-size: 28px;
            animation: poopBlink 4s ease-in-out infinite;
            filter: drop-shadow(0 0 2px rgba(141,110,99,0.35));
        }
        @keyframes poopBlink {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1, h2 {
            text-align: center;
            color: #bb86fc;
            text-shadow: 0 0 10px rgba(187, 134, 252, 0.3);
        }
        h1 {
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .subtitle {
            text-align: center;
            color: #9aa7b0;
            font-style: italic;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .chart-container {
            width: 95%;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            position: relative;
            height: 400px;
            opacity: 1; /* always visible */
            transform: translateY(0);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        .chart-container.visible { opacity: 1; transform: translateY(0); }
        .chart-container::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(187,134,252,0.35), rgba(3,218,198,0.2));
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                    mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
                    mask-composite: exclude;
            pointer-events: none;
        }
        .chart-container:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
        .emoji-big { animation: glow 2.4s ease-in-out infinite; }
        @keyframes glow {
            0%,100% { filter: drop-shadow(0 0 0px rgba(255,193,7,0.0)); transform: translateY(0); }
            50% { filter: drop-shadow(0 0 8px rgba(255,193,7,0.6)); transform: translateY(-2px); }
        }
        .legend .emoji { animation: twinkle 3s ease-in-out infinite; display: inline-block; }
        @keyframes twinkle { 0%,100% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(-8deg) scale(1.08); } }
        .emoji {
            font-size: 1.4em;
            margin: 0 4px;
        }
        .legend {
            text-align: center;
            font-size: 0.9em;
            color: #aaa;
            margin: 15px 0;
        }
        .info-box {
            background: #2c3642;
            padding: 18px;
            border-radius: 10px;
            margin: 25px 0;
            font-size: 1em;
            border-left: 5px solid #03dac6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .flex {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }
        .flex .day {
            text-align: center;
            background: #2c3642;
            padding: 14px;
            border-radius: 10px;
            flex: 1;
            min-width: 160px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 1px solid #3a3a3a;
            transition: all 0.3s;
        }
        .flex .day:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .flex .emoji-big {
            font-size: 2.2em;
            line-height: 1;
            text-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
        }
        footer {
            text-align: center;
            margin-top: 50px;
            color: #666;
            font-size: 0.85em;
            animation: float 3s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .loading {
            text-align: center;
            color: #bb86fc;
            font-size: 1.2em;
            margin: 20px 0;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .loading.visible {
            opacity: 1;
        }
        /* Foreground poop rain overlay */
        .poop-rain {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }
        .poop-drop {
            position: absolute;
            will-change: transform, opacity;
            font-size: 110px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.45));
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-20vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh) rotate(180deg); opacity: 0.85; }
        }
    </style>
</head>
<body>
    <div class="poop-background" id="poopBg" aria-hidden="true"></div>
    <div class="poop-rain" id="poopRain" aria-hidden="true"></div>
    <div class="container" style="position: relative; z-index: 1;">
        <h1>–ê–Ω–∞–ª–∏–∑ –ø–æ–µ–∑–¥–∫–∏ Cabbakid üö¥‚Äç‚ôÇÔ∏è</h1>
        <p class="subtitle">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –ø–æ–≥–æ–¥–∞, –∑–¥–æ—Ä–æ–≤—å–µ –∏ <span class="emoji">üí©</span> –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –≤–µ–ª–æ-–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</p>

        <div class="info-box">
            <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ‚Üí –ö–∏–ø—É—è (119 –∫–º) ‚Üí –°—è—Å—å—Ç—Ä–æ–π (35 –∫–º) ‚Üí –ü–∞—à–∞ ‚Üí –õ–æ–¥–µ–π–Ω–æ–µ –ø–æ–ª–µ (98 –∫–º)</p>
            <p><strong>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</strong> –í–µ–ª–æ—Å–∏–ø–µ–¥ üö¥‚Äç‚ôÇÔ∏è | <strong>–û—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> —Ç—É–∞–ª–µ—Ç—ã üöΩ –∏ <span class="emoji">ü§¢</span></p>
        </div>

        <div class="flex">
            <div class="day">
                <div class="emoji-big">üö¥‚Äç‚ôÇÔ∏è</div>
                <p><strong>–î–µ–Ω—å 1</strong><br>–°–ü–± ‚Üí –ö–∏–ø—É—è<br>119 –∫–º</p>
            </div>
            <div class="day">
                <div class="emoji-big">üö¥‚Äç‚ôÇÔ∏è</div>
                <p><strong>–î–µ–Ω—å 2</strong><br>–ö–∏–ø—É—è ‚Üí –°—è—Å—å—Ç—Ä–æ–π<br>35 –∫–º</p>
            </div>
            <div class="day">
                <div class="emoji-big">üö¥‚Äç‚ôÇÔ∏èüí©</div>
                <p><strong>–î–µ–Ω—å 3</strong><br>–°—è—Å—å—Ç—Ä–æ–π ‚Üí –ü–∞—à–∞ ‚Üí –õ–æ–¥–µ–π–Ω–æ–µ –ø–æ–ª–µ<br>98 –∫–º</p>
            </div>
        </div>

        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–∫–∏...</div>

        <!-- –î–∏–∞–≥—Ä–∞–º–º—ã -->
        <div class="chart-container" id="tempPoopChart">
            <canvas id="canvasTempPoop"></canvas>
            <p class="legend">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ vs üí© –î–µ—Ñ–µ–∫–∞—Ü–∏–∏ ‚Äî —á–µ–º –∂–∞—Ä—á–µ, —Ç–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –∫–∏—à–µ—á–Ω–∏–∫? –°—Ä–∞–≤–Ω–∏–º –≥–æ—Ä–æ–¥–∞ –∏ –∑–∞–º–µ—Ç–∏–º –ø–∏–∫–∏.</p>
        </div>

        <div class="chart-container" id="humidityPoopChart">
            <canvas id="canvasHumidityPoop"></canvas>
            <p class="legend">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å vs üí© –î–µ—Ñ–µ–∫–∞—Ü–∏–∏ ‚Äî –∫–∞–∫ —Å—ã—Ä–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç—É? –ò—â–µ–º –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏.</p>
        </div>

        <div class="chart-container" id="weatherPoopChart">
            <canvas id="canvasWeatherPoop"></canvas>
            <p class="legend">‚òÅÔ∏è/üåßÔ∏è –ü–æ–≥–æ–¥–∞ –∏ —Å—É–º–º–∞—Ä–Ω—ã–µ üí© ‚Äî –≤ –∫–∞–∫–æ–π –ø–æ–≥–æ–¥–µ –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —á–∞—â–µ?</p>
        </div>

        <div class="chart-container" id="waterSleepChart">
            <canvas id="canvasWaterSleep"></canvas>
            <p class="legend">üöø –ù–∞–ª–∏—á–∏–µ —Ç—ë–ø–ª–æ–π –≤–æ–¥—ã –∏ üò¥ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ ‚Äî –≤–ª–∏—è–µ—Ç –ª–∏ –∫–æ–º—Ñ–æ—Ä—Ç –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ?</p>
        </div>

        <div class="chart-container" id="poisoningPoopChart">
            <canvas id="canvasPoisoningPoop"></canvas>
            <p class="legend">ü§¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ üí© ‚Äî –∫–∞–∫ –≤–ª–∏—è–µ—Ç –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ?</p>
        </div>

        <div class="chart-container" id="distanceChart">
            <canvas id="canvasDistance"></canvas>
            <p class="legend">üö¥‚Äç‚ôÇÔ∏è –ü—Ä–æ–±–µ–≥ (–∫–º) vs üí© ‚Äî –±–æ–ª—å—à–µ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤, –±–æ–ª—å—à–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫? –°–æ–ø–æ—Å—Ç–∞–≤–∏–º.</p>
        </div>

        <footer>–ê–Ω–∞–ª–∏–∑ –≤–µ–ª–æ-–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è Cabbakid: –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ, –∑–¥–æ—Ä–æ–≤—å–µ –∏ <span class="emoji">üí©</span> | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –ª—é–±–æ–≤—å—é ‚ù§Ô∏è</footer>
    </div>

    <script>
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loading').classList.add('visible');

        // –î–∞–Ω–Ω—ã–µ
        const data = [
            { city: "–ö–∏–ø—É—è", temp: 10, humidity: 84, weather: "–î–æ–∂–¥—å", warmWater: false, sleep: "–ø–ª–æ—Ö–æ", poisoned: true, poopCount: 5, distance: 119 },
            { city: "–°—è—Å—å—Ç—Ä–æ–π", temp: 15, humidity: 76, weather: "–û–±–ª–∞—á–Ω–æ", warmWater: false, sleep: "–ø–ª–æ—Ö–æ", poisoned: true, poopCount: 8, distance: 35 },
            { city: "–ü–∞—à–∞", temp: 15, humidity: 71, weather: "–û–±–ª–∞—á–Ω–æ", warmWater: null, sleep: null, poisoned: false, poopCount: 4, distance: 0 },
            { city: "–õ–æ–¥–µ–π–Ω–æ–µ –ø–æ–ª–µ", temp: 14, humidity: 90, weather: "–î–æ–∂–¥—å", warmWater: true, sleep: "—Ö–æ—Ä–æ—à–æ", poisoned: false, poopCount: 10, distance: 98 }
        ];

        const allCities = data.map(d => d.city);
        const filteredData = data.filter(d => d.city !== "–ü–∞—à–∞");

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–Ω–∏–π —Ñ–æ–Ω –∏–∑ —Å–ª–µ–≥–∫–∞ –º–∏–≥–∞—é—â–∏—Ö –∫–∞–∫–∞—à–µ–∫
        (function generatePoopBackground() {
            const holder = document.getElementById('poopBg');
            const rows = 8; const cols = 14; // more density
            const vw = window.innerWidth; const vh = window.innerHeight;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const span = document.createElement('span');
                    span.className = 'poop';
                    span.textContent = 'üí©';
                    const x = (c + Math.random()*0.4) / cols * vw;
                    const y = (r + Math.random()*0.4) / rows * vh;
                    span.style.left = x + 'px';
                    span.style.top = y + 'px';
                    span.style.animationDelay = (Math.random()*4).toFixed(2) + 's';
                    span.style.opacity = (0.35 + Math.random()*0.3).toFixed(2); // stronger visibility
                    holder.appendChild(span);
                }
            }
            window.addEventListener('resize', () => { holder.innerHTML=''; generatePoopBackground(); }, { once: true });
        })();

        // Foreground 10s poop rain on load
        function startPoopRain(durationMs = 10000) {
            const rain = document.getElementById('poopRain');
            const count = Math.floor(window.innerWidth / 20); // responsive amount
            const createDrop = (delayMs) => {
                const span = document.createElement('span');
                span.className = 'poop-drop';
                span.textContent = Math.random() < 0.85 ? 'üí©' : 'üöΩ';
                const startX = Math.random() * window.innerWidth;
                const dur = 2500 + Math.random() * 2500;
                span.style.left = startX + 'px';
                span.style.animationDuration = dur + 'ms';
                span.style.animationDelay = delayMs + 'ms';
                rain.appendChild(span);
                setTimeout(() => { span.remove(); }, delayMs + dur + 100);
            };
            for (let i = 0; i < count; i++) {
                createDrop(Math.random()*1500);
            }
            const interval = setInterval(() => {
                for (let i = 0; i < Math.max(6, Math.floor(count*0.15)); i++) createDrop(0);
            }, 400);
            setTimeout(() => { clearInterval(interval); }, durationMs);
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
        function animateCharts() {
            const charts = document.querySelectorAll('.chart-container');
            charts.forEach((chart, index) => {
                setTimeout(() => {
                    chart.classList.add('visible');
                }, 600 + index * 400);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        function createChart(canvasId, config) {
            const canvas = document.getElementById(canvasId);
            const parent = canvas.parentElement;
            // ensure canvas matches container
            canvas.width = Math.max(parent.clientWidth - 40, 320);
            canvas.height = Math.max(parent.clientHeight - 60, 220);
            const ctx = canvas.getContext('2d');
            let animationFrame;
            let progress = 0;

            const render = () => {
                if (progress < 1) {
                    progress = Math.min(progress + 0.02, 1);
                    drawFrame(ctx, config, progress);
                    animationFrame = requestAnimationFrame(render);
                } else {
                    drawFrame(ctx, config, 1);
                }
            };

            const drawFrame = (ctx, config, progress) => {
                const type = config.type;
                const data = config.data;
                const options = config.options;
                const width = ctx.canvas.width;
                const height = ctx.canvas.height;
                const labels = data.labels || [];
                const datasets = data.datasets || [];

                ctx.clearRect(0, 0, width, height);

                // –¢–µ–º–Ω—ã–π —Ñ–æ–Ω
                ctx.fillStyle = '#1e1e1e';
                ctx.fillRect(0, 0, width, height);

                if (type === 'bar' || type === 'line') {
                    const barWidth = 40;
                    const spacing = (width - labels.length * barWidth) / (labels.length + 1);
                    const startX = spacing;
                    const maxValue = Math.max(...datasets.flatMap(d => d.data));
                    const niceMax = Math.pow(10, Math.floor(Math.log10(maxValue)));
                    const maxY = Math.ceil(maxValue / niceMax * 5) * (niceMax / 5) * 1.1; // nice rounding
                    const yAxisLeft = 40;
                    const chartBottom = height - 80;
                    const chartTop = 50;

                    // grid and ticks
                    const tickCount = 5;
                    const step = maxY / tickCount;
                    ctx.strokeStyle = '#2f2f2f';
                    ctx.lineWidth = 1;
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#9aa7b0';
                    for (let t = 0; t <= tickCount; t++) {
                        const value = t * step;
                        const y = chartBottom - (value / maxY) * (chartBottom - chartTop);
                        ctx.beginPath();
                        ctx.moveTo(yAxisLeft, y);
                        ctx.lineTo(width - 20, y);
                        ctx.stroke();
                        ctx.fillText(Math.round(value).toString(), 6, y + 4);
                    }

                    labels.forEach((label, index) => {
                        const x = startX + index * (barWidth + spacing);
                        datasets.forEach((dataset, dsIndex) => {
                            if (dataset.type === 'line') {
                                if (index > 0) {
                                    const prevX = startX + (index - 1) * (barWidth + spacing) + barWidth / 2;
                                    const prevY = chartBottom - (dataset.data[index - 1] / maxY) * (chartBottom - chartTop) * progress;
                                    const currX = x + barWidth / 2;
                                    const currY = chartBottom - (dataset.data[index] / maxY) * (chartBottom - chartTop) * progress;
                                    ctx.beginPath();
                                    ctx.moveTo(prevX, prevY);
                                    ctx.lineTo(currX, currY);
                                    ctx.strokeStyle = dataset.borderColor || '#bb86fc';
                                    ctx.lineWidth = 3;
                                    ctx.stroke();
                                }
                                const pointY = chartBottom - (dataset.data[index] / maxY) * (chartBottom - chartTop) * progress;
                                ctx.beginPath();
                                ctx.arc(x + barWidth / 2, pointY, 6, 0, 2 * Math.PI);
                                ctx.fillStyle = dataset.borderColor || '#bb86fc';
                                ctx.fill();
                                // draw emoji for line point if provided
                                if (dataset.emoji) {
                                    ctx.font = '20px "Segoe UI Emoji", "Apple Color Emoji", Arial';
                                    ctx.textAlign = 'center';
                                    ctx.fillText(dataset.emoji, x + barWidth / 2, pointY - 12);
                                }
                            } else {
                                const barHeight = (dataset.data[index] / maxY) * (chartBottom - chartTop) * progress;
                                const y = chartBottom - barHeight;
                                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                                gradient.addColorStop(0, '#bb86fc');
                                gradient.addColorStop(1, '#3700b3');
                                ctx.fillStyle = gradient;
                                ctx.fillRect(x, y, barWidth, barHeight);
                                ctx.strokeStyle = '#03dac6';
                                ctx.lineWidth = 2;
                                ctx.strokeRect(x, y, barWidth, barHeight);
                                // emoji on top of bar
                                if (dataset.emoji) {
                                    ctx.font = '20px "Segoe UI Emoji", "Apple Color Emoji", Arial';
                                    ctx.textAlign = 'center';
                                    ctx.fillText(dataset.emoji, x + barWidth / 2, y - 6);
                                }
                            }
                        });
                        ctx.fillStyle = '#e0e0e0';
                        ctx.font = '12px Arial';
                        ctx.fillText(label, x + barWidth / 2, height - 10);
                    });

                    // –û—Å–∏
                    ctx.strokeStyle = '#3a3a3a';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(yAxisLeft, chartTop);
                    ctx.lineTo(yAxisLeft, chartBottom);
                    ctx.lineTo(width - 20, chartBottom);
                    ctx.stroke();

                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    ctx.fillStyle = '#bb86fc';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(options.plugins.title.text, width / 2 - 100, 30);
                }

                if (type === 'pie') {
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    let startAngle = -Math.PI / 2;
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const radius = Math.min(centerX, centerY) - 60;

                    const sliceEmojis = options.sliceEmojis || [];
                    data.datasets[0].data.forEach((value, i) => {
                        const sliceAngle = (value / total) * 2 * Math.PI * progress;
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                        ctx.closePath();
                        ctx.fillStyle = data.datasets[0].backgroundColor[i];
                        ctx.fill();
                        ctx.strokeStyle = '#121212';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // draw emoji near the middle of the slice arc
                        if (sliceEmojis[i]) {
                            const mid = startAngle + sliceAngle / 2;
                            const ex = centerX + Math.cos(mid) * (radius - 25);
                            const ey = centerY + Math.sin(mid) * (radius - 25);
                            ctx.font = '22px "Segoe UI Emoji", "Apple Color Emoji", Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(sliceEmojis[i], ex, ey);
                        }

                        startAngle += sliceAngle;
                    });

                    ctx.fillStyle = '#bb86fc';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(options.plugins.title.text, width / 2 - 120, 30);
                }
            };

            setTimeout(() => {
                animationFrame = requestAnimationFrame(render);
            }, 200);

            // Redraw on resize at final state
            window.addEventListener('resize', () => {
                canvas.width = Math.max(parent.clientWidth - 40, 320);
                canvas.height = Math.max(parent.clientHeight - 60, 220);
                drawFrame(ctx, config, 1);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                animateCharts();
                startPoopRain(10000);

                // –ì—Ä–∞—Ñ–∏–∫–∏
                setTimeout(() => createChart('canvasTempPoop', {
                    type: 'bar',
                    data: {
                        labels: allCities,
                        datasets: [
                            { label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', data: data.map(d => d.temp), type: 'bar', borderColor: '#03dac6' },
                            { label: '–ö–∞–∫–∞—à–∫–∏ üí©', data: data.map(d => d.poopCount), type: 'line', borderColor: '#8d6e63' }
                        ]
                    },
                    options: { plugins: { title: { text: 'üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –∫–∞–∫–∞—à–∫–∏' } } }
                }), 300);

                setTimeout(() => createChart('canvasHumidityPoop', {
                    type: 'bar',
                    data: {
                        labels: allCities,
                        datasets: [
                            { label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å', data: data.map(d => d.humidity), type: 'bar', borderColor: '#29b6f6' },
                            { label: '–ö–∞–∫–∞—à–∫–∏ üí©', data: data.map(d => d.poopCount), type: 'line', borderColor: '#8d6e63' }
                        ]
                    },
                    options: { plugins: { title: { text: 'üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –∏ –∫–∞–∫–∞—à–∫–∏' } } }
                }), 700);

                setTimeout(() => createChart('canvasWeatherPoop', {
                    type: 'pie',
                    data: {
                        labels: ['–î–æ–∂–¥—å', '–û–±–ª–∞—á–Ω–æ'],
                        datasets: [{
                            data: ['–î–æ–∂–¥—å', '–û–±–ª–∞—á–Ω–æ'].map(w => data.filter(d => d.weather === w).reduce((a, b) => a + b.poopCount, 0)),
                            backgroundColor: ['#f44336', '#2196f3']
                        }]
                    },
                    options: { plugins: { title: { text: '‚òî –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∫–∞—à–µ–∫ –ø–æ –ø–æ–≥–æ–¥–µ' } }, sliceEmojis: ['üåßÔ∏è','‚òÅÔ∏è'] }
                }), 1100);

                setTimeout(() => createChart('canvasWaterSleep', {
                    type: 'bar',
                    data: {
                        labels: ['–ø–ª–æ—Ö–æ', '—Ö–æ—Ä–æ—à–æ'],
                        datasets: [
                            { label: '–ï—Å—Ç—å –≤–æ–¥–∞ üöø', data: [1, 1], backgroundColor: '#03dac6' },
                            { label: '–ù–µ—Ç –≤–æ–¥—ã üö´', data: [2, 0], backgroundColor: '#cf6679' }
                        ]
                    },
                    options: { plugins: { title: { text: 'üöø –í–ª–∏—è–Ω–∏–µ –≤–æ–¥—ã –Ω–∞ —Å–æ–Ω' } } }
                }), 1500);

                setTimeout(() => createChart('canvasPoisoningPoop', {
                    type: 'bar',
                    data: {
                        labels: ['–û—Ç—Ä–∞–≤–∏–ª—Å—è ü§¢', '–ó–¥–æ—Ä–æ–≤ ‚úÖ'],
                        datasets: [{
                            label: '–°—Ä–µ–¥–Ω–µ–µ üí©',
                            data: [6.5, 7],
                            backgroundColor: ['#ff5252', '#304ffe']
                        }]
                    },
                    options: { plugins: { title: { text: 'ü§¢ –û—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∫–∞—à–µ–∫' } } }
                }), 1900);

                setTimeout(() => createChart('canvasDistance', {
                    type: 'bar',
                    data: {
                        labels: allCities,
                        datasets: [
                            { label: '–ö–º –ø—Ä–æ–π–¥–µ–Ω–æ', data: data.map(d => d.distance), type: 'bar', borderColor: '#00e5ff', emoji: 'üö¥‚Äç‚ôÇÔ∏è' },
                            { label: '–ö–∞–∫–∞—à–∫–∏ üí©', data: data.map(d => d.poopCount), type: 'line', borderColor: '#ff1744', emoji: 'üí©' }
                        ]
                    },
                    options: { plugins: { title: { text: 'üö¥‚Äç‚ôÇÔ∏è –ü—Ä–æ–π–¥–µ–Ω–æ –∫–º –∏ –∫–∞–∫–∞—à–∫–∏' } } }
                }), 2300);
            }, 800);
        };
    </script>
</body>
</html>
